<!DOCTYPE html>
<html>
<head>
  <title>LyzoR</title>
</head>
<body>
  <h2>LyzoR Lite - Real-Time Test</h2>

  <!-- Language selector -->
  <label for="targetLang">Translate to:</label>
  <select id="targetLang">
    <option value="en">English</option>
    <option value="pt">Portuguese</option>
    <option value="es">Spanish</option>
    <option value="fr">French</option>
    <option value="de">German</option>
  </select>
  <br><br>

  <button id="startBtn">Start Session</button>
  <button id="stopBtn">End Session</button>
  <audio id="audioPlayer" controls></audio>

  <script>
    let ws;
    let mediaRecorder;
    let audioStream;

    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const player = document.getElementById("audioPlayer");
    const targetLangSelect = document.getElementById("targetLang");

    startBtn.onclick = async () => {
      ws = new WebSocket("ws://localhost:8000/ws/meeting");
      ws.binaryType = "arraybuffer";

      ws.onopen = () => console.log("Connected to LyzoR!");
      ws.onclose = () => console.log("Session ended.");
      ws.onerror = (e) => console.error("WebSocket error:", e);

      ws.onmessage = (event) => {
        // Receive TTS audio and play
        const blob = new Blob([event.data], { type: "audio/wav" });
        player.src = URL.createObjectURL(blob);
        player.play();
      };

      // Capture microphone
      audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(audioStream);

      mediaRecorder.ondataavailable = (e) => {
        if (e.data.size > 0 && ws.readyState === WebSocket.OPEN) {
          e.data.arrayBuffer().then(buffer => {
            ws.send(JSON.stringify({
              audio: Array.from(new Uint8Array(buffer)),
              sender: "user",
              target_lang: targetLangSelect.value  // dynamically selected language
            }));
          });
        }
      };

      mediaRecorder.start(200); // send chunks every 200ms
      console.log("Recording started...");
    };

    stopBtn.onclick = () => {
      if (mediaRecorder) mediaRecorder.stop();
      if (audioStream) audioStream.getTracks().forEach(track => track.stop());
      if (ws) ws.close();
      console.log("Session ended by user.");
    };
  </script>
</body>
</html>
